/* Copyright 2020 ZSA Technology Labs, Inc <@zsa>
 * Copyright 2020 Jack Humbert <jack.humb@gmail.com>
 * Copyright 2020 Christopher Courtney <drashna@live.com> (@drashna)
 * Copyright 2021 Gauthier Sebaux <github@zeronounours.eu> (@zeronounours)
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */



#include QMK_KEYBOARD_H
#include "version.h"
#include "keymap_french.h"
#include "keymap_bepo.h"

enum layers {
    BEPO__,     // default layer for bépo layouts
    B4AZER,     // bépo layout for azerty keyboards
    B4AZ_A,     // bépo layout for azerty keyboards — AltGr version
    B4AZ_S,     // bépo layout for azerty keyboards — shifted version
    SHRB4Z,     // Shortcuts for B4Z
    SYMBOL,     // Layer with symbols
    MEDIA_,     // media keys
    COLORS,     // Manage the colors of the keyboards
    TERM__,     // Shortcuts to manage the terminal
    VIM___,     // Shortcuts for vim

    LAYERS,     // To chose the layer to switch to. Make it on top of all others

    __LAYER_END__,  // keep it at the end
};

enum custom_keycodes {
    RGB_SLD = SAFE_RANGE,
    COLOR_RED,
    COLOR_BLUE,
    COLOR_GREEN,
    COLOR_PURPLE,
    COLOR_YELLOW,
    RST_LAYER,  // Reset layers to the current default
    MC_VIM_P_TAB,
    MC_VIM_N_TAB,
    MC_VIM_SAVE,
    MC_VIM_SV_QT,
    MC_VIM_QUIT,
    FR_TRIPLE_DOT,
    SHRB4Z_WORD_MODE,
	WORD_NB_SPACE,
};

// Tap Dance declarations
enum {
    TD_SHF_ALT,
    __TD_END__,  // keep it at the end
};

extern rgb_config_t rgb_matrix_config;

// To know whether word mode is enabled
static bool g_word_mode;

/****************************************
 * KEYBOARD INITIALISATION
 ***************************************/

void keyboard_post_init_user(void) {
    // activate rgb matrix
    rgb_matrix_enable();

	// disable word mode
	g_word_mode = false;
}


/****************************************
 * KEY MAPPING
 ***************************************/

// make the transparent key macro longer
#define ____________ KC_TRNS
// key mapping
const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
//
// Keymap BEPO__: default layer for bépo layouts
//
//┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐             ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
//│LT(SYM,$)│  " / 1  │  « / 2  │  » / 3  │  ( / 4  │  ) / 5  │   HOME  │             │  PG UP  │  @ / 6  │  + / 7  │  - / 8  │  / / 9  │  * / 0  │    =    │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤             ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│   TAB   │    B    │    É    │    P    │    O    │    È    │   END   │             │ PG DOWN │    ^    │    V    │    D    │    L    │    J    │    Z    │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤             ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│    W    │    A    │    U    │    I    │    E    │    ,    │  INSERT │             │         │    C    │    T    │    S    │    R    │    N    │    M    │
//├─────────┼─────────┼─────────┼─────────┼───═══───┼─────────┼─────────┘             └─────────┼─────────┼───═══───┼─────────┼─────────┼─────────┼─────────┤
//│ LSHIFT  │    À    │    Y    │    X    │    :    │    K    │                                 │    '    │    Q    │    G    │    H    │    F    │    Ç    │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┘                                 └─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│  LCTRL  │ Layers  │  RCTRL  │   Win   │   Meh   │  ╔═════════════╗                   ╔═════════════╗  │    ⇦    │    ⇩    │    ⇧    │    ⇨    │    %    │
//└─────────┴─────────┴─────────┴─────────┴─────────┘  ║  Terminal   ║                   ║  Backspace  ║  └─────────┴─────────┴─────────┴─────────┴─────────┘
//                                                     ║             ║                   ║             ║
//                                                     ╠══════╦══════╬══════╗     ╔══════╬══════╦══════╣
//                                                     ║      ║      ║      ║     ║      ║      ║1 tap ║
//                                                     ║Space ║ LALT ║Escape║     ║ Vim  ║Enter ║RSHIFT║
//                                                     ║      ║      ║  --  ║     ║      ║  --  ║2 tap ║
//                                                     ║      ║      ║LCTRL ║     ║      ║ RALT ║S+RALT║
//                                                     ╚══════╩══════╩══════╝     ╚══════╩══════╩══════╝
//
  [BEPO__] = LAYOUT_moonlander(
    LT(SYMBOL, BP_DLR) , BP_DQUO, BP_LDAQ      , BP_RDAQ      , BP_LPRN      , BP_RPRN      , KC_HOME               ,          KC_PGUP      , BP_AT        , BP_PLUS      , BP_MINS      , BP_SLSH      , BP_ASTR      , BP_EQL       ,
    KC_TAB       , BP_B         , BP_EACU      , BP_P         , BP_O         , BP_EGRV      , KC_END                ,          KC_PGDN      , BP_DCIR      , BP_V         , BP_D         , BP_L         , BP_J         , BP_Z         ,
    BP_W         , BP_A         , BP_U         , BP_I         , BP_E         , BP_COMM      , KC_INSERT             ,          ____________ , BP_C         , BP_T         , BP_S         , BP_R         , BP_N         , BP_M         ,
    KC_LSFT      , BP_AGRV      , BP_Y         , BP_X         , BP_DOT       , BP_K                                                         , BP_QUOT      , BP_Q         , BP_G         , BP_H         , BP_F         , BP_CCED      ,
    KC_LCTL      , MO(LAYERS)   , KC_RCTL      , KC_LGUI      , KC_MEH       ,                MO(TERM__)            ,          KC_BSPC                     , KC_LEFT      , KC_DOWN      , KC_UP        , KC_RIGHT     , BP_PERC      ,
                                                                KC_SPACE     , KC_LALT      , LCTL_T(KC_ESCAPE)     ,          MO(VIM___)   , RALT_T(KC_ENTER) , TD(TD_SHF_ALT)
  ),
//
// Keymap B4AZER: The base layer to type as bépo on an azerty layout
//
//┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐             ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
//│LT(SYM,$)│    "    │    "    │    "    │    (    │    )    │   HOME  │             │  PG UP  │    @    │    +    │    -    │    /    │    *    │    =    │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤             ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│   TAB   │    b    │    é    │    p    │    o    │    è    │   END   │             │ PG DOWN │    ^    │    v    │    d    │    l    │    j    │    z    │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤             ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│    w    │    u    │    u    │    i    │    e    │    ,    │  INSERT │             │         │    c    │    t    │    s    │    r    │    n    │    m    │
//├─────────┼─────────┼─────────┼─────────┼───═══───┼─────────┼─────────┘             └─────────┼─────────┼───═══───┼─────────┼─────────┼─────────┼─────────┤
//│ LSHIFT  │    à    │    y    │    x    │    .    │    k    │                                 │    '    │    q    │    g    │    h    │    f    │    ç    │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┘                                 └─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│  LCTRL  │ Layers  │  RCTRL  │   Win   │   Meh   │  ╔═════════════╗                   ╔═════════════╗  │    ⇦    │    ⇩    │    ⇧    │    ⇨    │    %    │
//└─────────┴─────────┴─────────┴─────────┴─────────┘  ║  Shortcuts  ║                   ║  Backspace  ║  └─────────┴─────────┴─────────┴─────────┴─────────┘
//                                                     ║             ║                   ║             ║
//                                                     ╠══════╦══════╬══════╗     ╔══════╬══════╦══════╣
//                                                     ║      ║      ║      ║     ║      ║      ║      ║
//                                                     ║Space ║ LALT ║Escape║     ║ Vim  ║Enter ║RSHIFT║
//                                                     ║      ║      ║  --  ║     ║      ║  --  ║      ║
//                                                     ║      ║      ║LCTRL ║     ║      ║ RALT ║      ║
//                                                     ╚══════╩══════╩══════╝     ╚══════╩══════╩══════╝
//
  [B4AZER] = LAYOUT_moonlander(
    LT(SYMBOL, FR_DLR), FR_DQUO , FR_DQUO      , FR_DQUO      , FR_LPRN      , FR_RPRN      , KC_HOME               ,          KC_PGUP      , FR_AT        , FR_PLUS      , FR_MINS      , FR_SLSH      , FR_ASTR      , FR_EQL       ,
    KC_TAB       , KC_B         , FR_EACU      , KC_P         , KC_O         , FR_EGRV      , KC_END                ,          KC_PGDN      , FR_CIRC      , KC_V         , KC_D         , KC_L         , KC_J         , FR_Z         ,
    FR_W         , FR_A         , KC_U         , KC_I         , KC_E         , FR_COMM      , KC_INSERT             ,          ____________ , KC_C         , KC_T         , KC_S         , KC_R         , KC_N         , FR_M         ,
    MO(B4AZ_S)   , FR_AGRV      , KC_Y         , KC_X         , FR_DOT       , KC_K         ,                                                 FR_QUOT      , FR_Q         , KC_G         , KC_H         , KC_F         , FR_CCED      ,
    KC_LCTL      , MO(LAYERS)   , KC_RCTL      , KC_LGUI      , KC_MEH       ,                MO(SHRB4Z)            ,          KC_BSPC                     , KC_LEFT      , KC_DOWN      , KC_UP        , KC_RIGHT     , FR_PERC      ,
                                                                KC_SPACE     , KC_LALT      , LCTL_T(KC_ESCAPE)     ,          MO(VIM___)   , LT(B4AZ_A, KC_ENTER) , MO(B4AZ_S)
  ),
//
// Keymap B4AZ_A: The AltGr-ed layer to type as bépo on an azerty layout
//
//┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐             ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
//│LT(SYM,$)│    "    │    <    │    >    │    [    │    ]    │         │             │         │    @    │    +    │    -    │    /    │    *    │    =    │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤             ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│         │    |    │    é    │    &    │    o    │    e    │         │             │         │    ^    │    v    │    d    │    l    │    j    │    z    │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤             ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│    w    │    a    │    ù    │  Trema  │    €    │    '    │         │             │         │    c    │    t    │    s    │    r    │    ~    │    m    │
//├─────────┼─────────┼─────────┼─────────┼───═══───┼─────────┼─────────┘             └─────────┼─────────┼───═══───┼─────────┼─────────┼─────────┼─────────┤
//│ LSHIFT  │    \    │    {    │    }    │    …    │    ~    │                                 │    '    │    q    │    g    │    h    │    f    │    ç    │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┘                                 └─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│         │ Layers  │         │         │         │  ╔═════════════╗                   ╔═════════════╗  │         │         │         │         │    %    │
//└─────────┴─────────┴─────────┴─────────┴─────────┘  ║  Shortcuts  ║                   ║             ║  └─────────┴─────────┴─────────┴─────────┴─────────┘
//                                                     ║             ║                   ║             ║
//                                                     ╠══════╦══════╬══════╗     ╔══════╬══════╦══════╣
//                                                     ║      ║      ║      ║     ║      ║ ---- ║      ║
//                                                     ║Under ║      ║      ║     ║ Vim  ║ ---- ║RSHIFT║
//                                                     ║score ║      ║      ║     ║      ║ ---- ║      ║
//                                                     ║      ║      ║      ║     ║      ║ ---- ║      ║
//                                                     ╚══════╩══════╩══════╝     ╚══════╩══════╩══════╝
//
  [B4AZ_A] = LAYOUT_moonlander(
    LT(SYMBOL, FR_DLR), FR_DQUO , FR_LABK      , FR_RABK      , FR_LBRC      , FR_RBRC      , ____________          ,          ____________ , FR_AT        , FR_PLUS      , FR_MINS      , FR_SLSH      , FR_ASTR      , FR_EQL       ,
    ____________ , FR_PIPE      , FR_EACU      , FR_AMPR      , KC_O         , FR_EGRV      , ____________          ,          ____________ , KC_LBRC      , KC_V         , KC_D         , KC_L         , KC_J         , FR_Z         ,
    FR_W         , FR_A         , FR_UGRV      , S(KC_LBRC)   , FR_EURO      , FR_QUOT      , ____________          ,          ____________ , KC_C         , KC_T         , KC_S         , KC_R         , FR_TILD      , FR_M         ,
    MO(B4AZ_S)   , FR_BSLS      , FR_LCBR      , FR_RCBR      , FR_TRIPLE_DOT, FR_TILD      ,                                                 FR_QUOT      , FR_Q         , KC_G         , KC_H         , KC_F         , FR_CCED      ,
    ____________ , MO(LAYERS)   , ____________ , ____________ , ____________ ,                MO(SHRB4Z)            ,          ____________                , ____________ , ____________ , ____________ , ____________ , BP_PERC      ,
                                                                FR_UNDS      , ____________ , ____________          ,          MO(VIM___)   , ____________ , MO(B4AZ_S)
  ),
//
// Keymap B4AZ_S: The Shifted layer to type as bépo on an azerty layout
//
//┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐             ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
//│    #    │    1    │    2    │    3    │    4    │    5    │         │             │ S(PG UP)│    6    │    7    │    8    │    9    │    0    │    °    │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤             ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│   TAB   │    B    │    E    │    P    │    O    │    È    │         │             │ S(PG DN)│    !    │    V    │    D    │    L    │    J    │    Z    │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤             ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│    W    │    A    │    U    │    I    │    E    │    ;    │S(INSERT)│             │         │    C    │    T    │    S    │    R    │    N    │    M    │
//├─────────┼─────────┼─────────┼─────────┼───═══───┼─────────┼─────────┘             └─────────┼─────────┼───═══───┼─────────┼─────────┼─────────┼─────────┤
//│ ------- │    A    │    Y    │    X    │    :    │    K    │                                 │    ?    │    Q    │    G    │    H    │    F    │    C    │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┘                                 └─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│  LCTRL  │ Layers  │  RCTRL  │   Win   │   Meh   │  ╔═════════════╗                   ╔═════════════╗  │    ⇦    │    ⇩    │    ⇧    │    ⇨    │    `    │
//└─────────┴─────────┴─────────┴─────────┴─────────┘  ║  Terminal   ║                   ║  Backspace  ║  └─────────┴─────────┴─────────┴─────────┴─────────┘
//                                                     ║             ║                   ║             ║
//                                                     ╠══════╦══════╬══════╗     ╔══════╬══════╦══════╣
//                                                     ║      ║      ║      ║     ║      ║      ║ ---- ║
//                                                     ║Space ║ LALT ║Escape║     ║ Vim  ║Enter ║ ---- ║
//                                                     ║ nbsp ║      ║  --  ║     ║      ║      ║ ---- ║
//                                                     ║(Word)║      ║LCTRL ║     ║      ║      ║ ---- ║
//                                                     ╚══════╩══════╩══════╝     ╚══════╩══════╩══════╝
//
  [B4AZ_S] = LAYOUT_moonlander(
    FR_HASH      , FR_1         , FR_2         , FR_3         , FR_4         , FR_5         , ____________          ,          S(KC_PGUP)   , FR_6         , FR_7         , FR_8         , FR_9         , FR_0         , FR_DEG       ,
    S(KC_TAB)    , S(KC_B)      , S(FR_E)      , S(KC_P)      , S(KC_O)      , S(KC_E)      , ____________          ,          S(KC_PGDN)   , FR_EXLM      , S(KC_V)      , S(KC_D)      , S(KC_L)      , S(KC_J)      , S(FR_Z)      ,
    S(FR_W)      , S(FR_A)      , S(KC_U)      , S(KC_I)      , S(KC_E)      , FR_SCLN      , S(KC_INSERT)          ,          ____________ , S(KC_C)      , S(KC_T)      , S(KC_S)      , S(KC_R)      , S(KC_N)      , S(FR_M)      ,
    ____________ , S(FR_A)      , S(KC_Y)      , S(KC_X)      , FR_COLN      , S(KC_K)      ,                                                 FR_QUES      , S(FR_Q)      , S(KC_G)      , S(KC_H)      , S(KC_F)      , S(KC_C)      ,
    S(KC_LCTL)   , MO(LAYERS)   , S(KC_RCTL)   , S(KC_LGUI)   , S(KC_MEH)    ,                MO(TERM__)            ,          ____________                , S(KC_LEFT)   , S(KC_DOWN)   , S(KC_UP)     , S(KC_RIGHT)  , FR_GRV       ,
                                                                WORD_NB_SPACE, S(KC_LALT)   , LCTL_T(KC_ESCAPE)     ,          MO(VIM___)   , S(KC_ENTER)  , ____________
  ),
//
// Keymap SHRB4Z: Shortcuts for Bépo4Azerty
//
//┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐             ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
//│         │         │         │         │         │         │         │             │         │         │         │         │         │         │         │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤             ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│         │         │         │         │         │         │         │             │         │         │         │         │         │         │         │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤             ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│         │         │         │         │         │         │         │             │         │         │         │         │         │         │         │
//├─────────┼─────────┼─────────┼─────────┼───═══───┼─────────┼─────────┘             └─────────┼─────────┼───═══───┼─────────┼─────────┼─────────┼─────────┤
//│ LSHIFT  │         │  Cut    │  Copy   │  Paste  │         │                                 │         │         │         │         │         │         │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┘                                 └─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│         │         │         │Word mode│         │  ╔═════════════╗                   ╔═════════════╗  │         │         │         │         │         │
//└─────────┴─────────┴─────────┴─────────┴─────────┘  ║             ║                   ║             ║  └─────────┴─────────┴─────────┴─────────┴─────────┘
//                                                     ║             ║                   ║             ║
//                                                     ╠══════╦══════╬══════╗     ╔══════╬══════╦══════╣
//                                                     ║      ║      ║      ║     ║      ║      ║      ║
//                                                     ║      ║      ║      ║     ║      ║      ║      ║
//                                                     ║      ║      ║      ║     ║      ║      ║      ║
//                                                     ║      ║      ║      ║     ║      ║      ║      ║
//                                                     ╚══════╩══════╩══════╝     ╚══════╩══════╩══════╝
//
  [SHRB4Z] = LAYOUT_moonlander(
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    KC_LSFT      , ____________ , LCTL(KC_X)   , LCTL(KC_C)   , LCTL(KC_V)   , ____________ ,                                                 ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , SHRB4Z_WORD_MODE, ____________ ,                ____________          ,          ____________                , ____________ , ____________ , ____________ , ____________ , ____________ ,
                                                                ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________
  ),
//
// Keymap LAYERS: a layer dedicated to the activation of alternative layers
//
//┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐             ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
//│         │  Bépo   │ Symbols │  Media  │Bépo4azer│ Colors  │         │             │         │         │         │         │         │         │         │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤             ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│Rst layer│         │         │         │         │         │         │             │         │         │         │         │         │         │         │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤             ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│         │         │         │         │         │         │         │             │         │         │         │         │         │         │         │
//├─────────┼─────────┼─────────┼─────────┼───═══───┼─────────┼─────────┘             └─────────┼─────────┼───═══───┼─────────┼─────────┼─────────┼─────────┤
//│ WebUSB  │         │         │         │         │         │                                 │         │         │         │         │         │         │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┘                                 └─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│         │ ------- │         │         │         │  ╔═════════════╗                   ╔═════════════╗  │         │         │         │         │         │
//└─────────┴─────────┴─────────┴─────────┴─────────┘  ║             ║                   ║             ║  └─────────┴─────────┴─────────┴─────────┴─────────┘
//                                                     ║             ║                   ║             ║
//                                                     ╠══════╦══════╬══════╗     ╔══════╬══════╦══════╣
//                                                     ║      ║      ║      ║     ║      ║      ║      ║
//                                                     ║      ║      ║      ║     ║      ║      ║      ║
//                                                     ║      ║      ║      ║     ║      ║      ║      ║
//                                                     ║      ║      ║      ║     ║      ║      ║      ║
//                                                     ╚══════╩══════╩══════╝     ╚══════╩══════╩══════╝
//
  [LAYERS] = LAYOUT_moonlander(
    ____________ , DF(BEPO__)   , TG(SYMBOL)   , TG(MEDIA_)   , DF(B4AZER)   , TG(COLORS)   , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    RST_LAYER    , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    WEBUSB_PAIR  , ____________ , ____________ , ____________ , ____________ , ____________                                                 , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ ,                ____________          ,          ____________                , ____________ , ____________ , ____________ , ____________ , ____________ ,
                                                                ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________
  ),
//
// Keymap SYMBOL: The layer with several symbols keys and a numpad
//
//┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐             ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
//│ Escape  │   F1    │   F2    │   F3    │   F4    │   F5    │   HOME  │             │  PG UP  │   F6    │   F7    │   F8    │   F9    │   F10   │   F11   │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤             ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│         │         │         │         │         │         │   END   │             │ PG DOWN │    ⇧    │    7    │    8    │    9    │    +    │   F12   │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤             ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│         │         │         │         │         │         │  INSERT │             │  DELETE │    ⇩    │    4    │    5    │    6    │    -    │         │
//├─────────┼─────────┼─────────┼─────────┼───═══───┼─────────┼─────────┘             └─────────┼─────────┼───═══───┼─────────┼─────────┼─────────┼─────────┤
//│         │         │         │         │         │         │                                 │         │    1    │    2    │    3    │    *    │         │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┘                                 └─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│         │ Layers  │         │         │         │  ╔═════════════╗                   ╔═════════════╗  │    0    │    .    │    =    │    /    │         │
//└─────────┴─────────┴─────────┴─────────┴─────────┘  ║             ║                   ║             ║  └─────────┴─────────┴─────────┴─────────┴─────────┘
//                                                     ║             ║                   ║             ║
//                                                     ╠══════╦══════╬══════╗     ╔══════╬══════╦══════╣
//                                                     ║      ║      ║      ║     ║      ║      ║      ║
//                                                     ║      ║      ║      ║     ║      ║      ║      ║
//                                                     ║      ║      ║      ║     ║      ║      ║      ║
//                                                     ║      ║      ║      ║     ║      ║      ║      ║
//                                                     ╚══════╩══════╩══════╝     ╚══════╩══════╩══════╝
//
  [SYMBOL] = LAYOUT_moonlander(
    KC_ESCAPE    , KC_F1        , KC_F2        , KC_F3        , KC_F4        , KC_F5        , KC_HOME               ,          KC_PGUP      , KC_F6        , KC_F7        , KC_F8        , KC_F9        , KC_F10       , KC_F11       ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , KC_END                ,          KC_PGDN      , KC_UP        , KC_KP_7      , KC_KP_8      , KC_KP_9      , KC_KP_PLUS   , KC_F12       ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , KC_INSERT             ,          KC_DELETE    , KC_DOWN      , KC_KP_4      , KC_KP_5      , KC_KP_6      , KC_KP_MINUS  , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,                                                 ____________ , KC_KP_1      , KC_KP_2      , KC_KP_3    , KC_KP_ASTERISK , ____________ ,
    ____________ , MO(LAYERS)   , ____________ , ____________ , ____________ ,                ____________          ,          ____________                , KC_KP_0      , KC_KP_DOT    , KC_KP_EQUAL  , KC_KP_SLASH  , ____________ ,
                                                                ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________
  ),
//
// Keymap MEDIA_: Layer with media keys and mouse
//
// MS == Mouse
//┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐             ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
//│Audio tgl│         │         │         │         │         │         │             │         │         │         │         │         │ Reboot  │ Bootldr │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤             ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│Music tgl│         │         │  MS UP  │         │         │         │             │         │         │         │         │         │         │         │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤             ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│Music mde│         │ MS LEFT │ MS DOWN │MS RIGHT │         │         │             │         │         │         │         │         │         │  Play   │
//├─────────┼─────────┼─────────┼─────────┼───═══───┼─────────┼─────────┘             └─────────┼─────────┼───═══───┼─────────┼─────────┼─────────┼─────────┤
//│         │         │         │         │         │         │                                 │         │         │   Prev  │  Next   │         │         │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┘                                 └─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│         │ Layers  │         │         │         │  ╔═════════════╗                   ╔═════════════╗  │ Vol. UP │Vol. DOWN│   MUTE  │         │         │
//└─────────┴─────────┴─────────┴─────────┴─────────┘  ║             ║                   ║             ║  └─────────┴─────────┴─────────┴─────────┴─────────┘
//                                                     ║             ║                   ║             ║
//                                                     ╠══════╦══════╬══════╗     ╔══════╬══════╦══════╣
//                                                     ║Mouse ║Mouse ║Mouse ║     ║      ║      ║      ║
//                                                     ║LEFT  ║MIDDLE║RIGHT ║     ║      ║      ║ WWW  ║
//                                                     ║BTN   ║BTN   ║BTN   ║     ║      ║      ║ Back ║
//                                                     ║      ║      ║      ║     ║      ║      ║      ║
//                                                     ╚══════╩══════╩══════╝     ╚══════╩══════╩══════╝
//
  [MEDIA_] = LAYOUT_moonlander(
    AU_TOGG      , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , QK_RBT       , QK_BOOT      ,
    MU_TOGG      , ____________ , ____________ , KC_MS_UP     , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    MU_NEXT      , ____________ , KC_MS_LEFT   , KC_MS_DOWN   , KC_MS_RIGHT  , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , KC_MEDIA_PLAY_PAUSE ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,                                                 ____________ , ____________ , KC_MEDIA_PREV_TRACK , KC_MEDIA_NEXT_TRACK , ____________ , ____________ ,
    ____________ , MO(LAYERS)   , ____________ , ____________ , ____________ ,                ____________          ,          ____________             , KC_AUDIO_VOL_UP , KC_AUDIO_VOL_DOWN , KC_AUDIO_MUTE , ____________ , ____________ ,
                                                                KC_MS_BTN1   , KC_MS_BTN3   , KC_MS_BTN2            ,          ____________ , ____________ , KC_WWW_BACK
  ),
//
// Keymap COLORS: layer to manage colors and animations
//
//┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐             ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
//│         │         │         │         │         │         │         │             │         │         │         │         │         │         │         │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤             ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│         │         │         │         │         │         │         │             │         │ Sat. UP │Bright UP│ Hue UP  │Speed UP │         │         │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤             ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│         │  Blue   │  Green  │ Yellow  │ Purple  │   Red   │         │             │         │ Sat. DN │Bright DN│ Hue DN  │Speed DN │         │         │
//├─────────┼─────────┼─────────┼─────────┼───═══───┼─────────┼─────────┘             └─────────┼─────────┼───═══───┼─────────┼─────────┼─────────┼─────────┤
//│         │         │         │         │         │         │                                 │         │         │         │         │         │         │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┘                                 └─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│         │ Layers  │         │         │         │  ╔═════════════╗                   ╔═════════════╗  │         │         │         │         │         │
//└─────────┴─────────┴─────────┴─────────┴─────────┘  ║ Change      ║                   ║ Toggle      ║  └─────────┴─────────┴─────────┴─────────┴─────────┘
//                                                     ║ Animation   ║                   ║ Lighting    ║
//                                                     ╠══════╦══════╬══════╗     ╔══════╬══════╦══════╣
//                                                     ║ Stop ║Layer ║      ║     ║      ║      ║      ║
//                                                     ║Animat║Color ║      ║     ║      ║      ║      ║
//                                                     ║      ║      ║      ║     ║      ║      ║      ║
//                                                     ║      ║      ║      ║     ║      ║      ║      ║
//                                                     ╚══════╩══════╩══════╝     ╚══════╩══════╩══════╝
//
  [COLORS] = LAYOUT_moonlander(
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , RGB_SAI      , RGB_VAI      , RGB_HUI      , RGB_SPI      , ____________ , ____________ ,
    ____________ , COLOR_BLUE   , COLOR_GREEN  , COLOR_YELLOW , COLOR_PURPLE , COLOR_RED    , ____________          ,          ____________ , RGB_SAD      , RGB_VAD      , RGB_HUD      , RGB_SPD      , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,                                                 ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , MO(LAYERS)   , ____________ , ____________ , ____________ ,                RGB_MOD               ,          RGB_TOG                     , ____________ , ____________ , ____________ , ____________ , ____________ ,
                                                                RGB_SLD      , TOGGLE_LAYER_COLOR , ____________    ,          ____________ , ____________ , ____________
  ),
//
// Keymap TERM__: A set of shortcuts for terminals
//
//┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐             ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
//│         │  I3 1   │  I3 2   │  I3 3   │  I3 4   │  I3 5   │         │             │Scroll UP│  I3 6   │  I3 7   │  I3 8   │  I3 9   │  I3 0   │         │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤             ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│         │  I3 A   │  I3 Z   │  I3 E   │  I3 R   │         │         │             │Scroll DN│  Copy   │  Paste  │         │         │         │         │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤             ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│         │  I3 Q   │  I3 S   │  I3 D   │  I3 F   │         │ SHF INS │             │         │  I3 H   │  I3 J   │  I3 K   │  I3 L   │  I3 M   │         │
//├─────────┼─────────┼─────────┼─────────┼───═══───┼─────────┼─────────┘             └─────────┼─────────┼───═══───┼─────────┼─────────┼─────────┼─────────┤
//│         │         │  I3 X   │  I3 C   │  I3 V   │         │                                 │         │         │         │         │         │         │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┘                                 └─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│         │         │         │         │         │  ╔═════════════╗                   ╔═════════════╗  │         │         │         │         │         │
//└─────────┴─────────┴─────────┴─────────┴─────────┘  ║ ----------- ║                   ║             ║  └─────────┴─────────┴─────────┴─────────┴─────────┘
//                                                     ║ ----------- ║                   ║             ║
//                                                     ╠══════╦══════╬══════╗     ╔══════╬══════╦══════╣
//                                                     ║ I3   ║      ║      ║     ║      ║ I3   ║      ║
//                                                     ║ Space║      ║      ║     ║      ║ Enter║      ║
//                                                     ║      ║      ║      ║     ║      ║      ║      ║
//                                                     ║      ║      ║      ║     ║      ║      ║      ║
//                                                     ╚══════╩══════╩══════╝     ╚══════╩══════╩══════╝
//
#define I3_MOD LALT
  [TERM__] = LAYOUT_moonlander(
    ____________ , I3_MOD(KC_1) , I3_MOD(KC_2) , I3_MOD(KC_3) , I3_MOD(KC_4) , I3_MOD(KC_5) , ____________          ,         LSFT(KC_PGUP) , I3_MOD(KC_6) , I3_MOD(KC_7) , I3_MOD(KC_8) , I3_MOD(KC_9) , I3_MOD(KC_0) , ____________ ,
    ____________ , I3_MOD(FR_A) , I3_MOD(FR_Z) , I3_MOD(KC_E) , I3_MOD(KC_R) , ____________ , ____________          ,         LSFT(KC_PGDN) , LCTL(LSFT(BP_C)) , LCTL(LSFT(BP_V)) , ____________ , ____________ , ____________ , ____________ ,
    ____________ , I3_MOD(FR_Q) , I3_MOD(KC_S) , I3_MOD(KC_D) , I3_MOD(KC_F) , ____________ , LSFT(KC_INSERT)       ,          ____________ , I3_MOD(KC_H) , I3_MOD(KC_J) , I3_MOD(KC_K) , I3_MOD(KC_L) , I3_MOD(FR_M) , ____________ ,
    ____________ , ____________ , I3_MOD(KC_X) , I3_MOD(KC_C) , I3_MOD(KC_V) , ____________ ,                                                 ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ ,                ____________          ,          ____________                , ____________ , ____________ , ____________ , ____________ , ____________ ,
                                                            I3_MOD(KC_SPACE) , ____________ , ____________          ,          ____________ , I3_MOD(KC_ENTER) , ____________
  ),
//
// Keymap VIM___: Contain macros for Vim
//
//┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐             ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
//│         │         │         │         │         │         │         │             │         │         │         │         │         │         │         │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤             ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│         │Prev Tab │Next Tab │         │         │         │         │             │         │         │         │         │         │         │         │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤             ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│ Save    │         │         │         │         │         │         │             │         │         │         │         │         │         │         │
//├─────────┼─────────┼─────────┼─────────┼───═══───┼─────────┼─────────┘             └─────────┼─────────┼───═══───┼─────────┼─────────┼─────────┼─────────┤
//│         │         │         │Save&Quit│         │         │                                 │         │  Quit   │         │         │         │         │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┘                                 └─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│         │         │         │         │         │  ╔═════════════╗                   ╔═════════════╗  │         │         │         │         │         │
//└─────────┴─────────┴─────────┴─────────┴─────────┘  ║             ║                   ║             ║  └─────────┴─────────┴─────────┴─────────┴─────────┘
//                                                     ║             ║                   ║             ║
//                                                     ╠══════╦══════╬══════╗     ╔══════╬══════╦══════╣
//                                                     ║      ║      ║      ║     ║ ---- ║      ║      ║
//                                                     ║Leader║      ║      ║     ║ ---- ║      ║      ║
//                                                     ║      ║      ║      ║     ║ ---- ║      ║      ║
//                                                     ║      ║      ║      ║     ║ ---- ║      ║      ║
//                                                     ╚══════╩══════╩══════╝     ╚══════╩══════╩══════╝
//
  [VIM___] = LAYOUT_moonlander(
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , MC_VIM_P_TAB , MC_VIM_N_TAB , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    MC_VIM_SAVE  , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , MC_VIM_SV_QT , ____________ , ____________ ,                                                 ____________ , MC_VIM_QUIT  , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ ,                ____________          ,          ____________                , ____________ , ____________ , ____________ , ____________ , ____________ ,
                                                                KC_SPACE     , ____________ , ____________          ,          ____________ , ____________ , ____________
  ),
/*
 * Add the following line for new layers
 *
 **********************************************************************************************************
//
// Keymap L_NAME: default layer
//
//┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐             ┌─────────┬─────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
//│         │         │         │         │         │         │         │             │         │         │         │         │         │         │         │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤             ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│         │         │         │         │         │         │         │             │         │         │         │         │         │         │         │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤             ├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│         │         │         │         │         │         │         │             │         │         │         │         │         │         │         │
//├─────────┼─────────┼─────────┼─────────┼───═══───┼─────────┼─────────┘             └─────────┼─────────┼───═══───┼─────────┼─────────┼─────────┼─────────┤
//│         │         │         │         │         │         │                                 │         │         │         │         │         │         │
//├─────────┼─────────┼─────────┼─────────┼─────────┼─────────┘                                 └─────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
//│         │         │         │         │         │  ╔═════════════╗                   ╔═════════════╗  │         │         │         │         │         │
//└─────────┴─────────┴─────────┴─────────┴─────────┘  ║             ║                   ║             ║  └─────────┴─────────┴─────────┴─────────┴─────────┘
//                                                     ║             ║                   ║             ║
//                                                     ╠══════╦══════╬══════╗     ╔══════╬══════╦══════╣
//                                                     ║      ║      ║      ║     ║      ║      ║      ║
//                                                     ║      ║      ║      ║     ║      ║      ║      ║
//                                                     ║      ║      ║      ║     ║      ║      ║      ║
//                                                     ║      ║      ║      ║     ║      ║      ║      ║
//                                                     ╚══════╩══════╩══════╝     ╚══════╩══════╩══════╝
//
  [L_NAME] = LAYOUT_moonlander(
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,                                                 ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ ,                ____________          ,          ____________                , ____________ , ____________ , ____________ , ____________ , ____________ ,
                                                                ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________
  ),
 **********************************************************************************************************
 */
};
// undefine transparency
#undef ____________



/****************************************
 * CUSTOM KEYS
 ***************************************/

bool process_record_user(uint16_t keycode, keyrecord_t *record) {
	  // If console is enabled, it will print the matrix position and status of each key pressed
#ifdef CONSOLE_ENABLE
    uprintf("KL: kc: 0x%04X, col: %2u, row: %2u, pressed: %u, time: %5u, int: %u, count: %u\n", keycode, record->event.key.col, record->event.key.row, record->event.pressed, record->event.time, record->tap.interrupted, record->tap.count);
#endif
    switch (keycode) {
        case RST_LAYER:
            // Reset the layers to the default one
            if (record->event.pressed) {
                layer_clear();
            }
            return false; // Skip all further processing of this key

        case FR_TRIPLE_DOT:
            if (record->event.pressed) {
                SEND_STRING("<<<");
            }
            break;

        case SHRB4Z_WORD_MODE:
            if (record->event.pressed) {
				// inverse the word mdoe
				g_word_mode = !g_word_mode;
            }
            break;

        case WORD_NB_SPACE:
            if (record->event.pressed) {
				if (g_word_mode) {
					tap_code16(C(S(KC_SPACE)));
				} else {
					tap_code(KC_SPACE);
				}
            }
            break;

        case MC_VIM_P_TAB:
            if (record->event.pressed) {
                SEND_STRING(SS_TAP(X_ESCAPE) SS_DELAY(100) SS_TAP(X_COMMA) SS_DELAY(100) SS_TAP(X_Q));
            }
            break;
        case MC_VIM_N_TAB:
            if (record->event.pressed) {
                SEND_STRING(SS_TAP(X_ESCAPE) SS_DELAY(100) SS_TAP(X_COMMA) SS_DELAY(100) SS_TAP(X_W));
            }
            break;
        case MC_VIM_SAVE:
            if (record->event.pressed) {
				SEND_STRING(SS_TAP(X_ESCAPE) SS_DELAY(100) SS_LSFT(SS_TAP(X_DOT)) SS_DELAY(100) SS_TAP(X_RBRC)  SS_DELAY(100) SS_TAP(X_ENTER));
            }
            break;
        case MC_VIM_SV_QT:
            if (record->event.pressed) {
                SEND_STRING(SS_TAP(X_ESCAPE) SS_DELAY(100) SS_LSFT(SS_TAP(X_DOT)) SS_DELAY(100) SS_TAP(X_C)  SS_DELAY(100) SS_TAP(X_ENTER));
            }
            break;
        case MC_VIM_QUIT:
            if (record->event.pressed) {
                SEND_STRING(SS_TAP(X_ESCAPE) SS_DELAY(100) SS_LSFT(SS_TAP(X_DOT)) SS_DELAY(100) SS_TAP(X_M) SS_DELAY(100) SS_TAP(X_A)  SS_DELAY(100) SS_TAP(X_ENTER));
            }
            break;

        case RGB_SLD:
            if (record->event.pressed) {
                rgblight_mode(1);
            }
            return false;

        case COLOR_BLUE:
            if (record->event.pressed) {
                rgblight_mode(1);
                rgblight_sethsv(172,255,255);
            }
            return false;
        case COLOR_GREEN:
            if (record->event.pressed) {
                rgblight_mode(1);
                rgblight_sethsv(86,255,128);
            }
            return false;
        case COLOR_YELLOW:
            if (record->event.pressed) {
                rgblight_mode(1);
                rgblight_sethsv(27,255,255);
            }
            return false;
        case COLOR_PURPLE:
            if (record->event.pressed) {
                rgblight_mode(1);
                rgblight_sethsv(215,255,128);
            }
            return false;
        case COLOR_RED:
            if (record->event.pressed) {
                rgblight_mode(1);
                rgblight_sethsv(0,255,255);
            }
            return false;
    }
    return true;
}


/****************************************
 * LAYER MANAGEMENT
 ***************************************/

layer_state_t layer_state_set_user(layer_state_t state) {
    // Ensure NUMPAD Lock is enabled when switching to numpad layer
    //  © konstantin
    bool numpad = IS_LAYER_ON_STATE(state, SYMBOL);
    if (numpad && ! host_keyboard_led_state().num_lock) {
         tap_code(KC_NUM);  // Toggle Num Lock to match Numpad layer state
    }

    return state;
}


/****************************************
 * COLOR MAPPING
 ***************************************/

/*
 * The following mapping is to be used to defined the colors of the keys
 *
 * It is advised to define colors as C preprecessor constants.
 * The following constants may also be used: C_TRANS. It is used to define
 * a transparent color and use the color of below layers (like for keys).
 *
 * NOTE: C_TRANS actually use a valid color which cannot then be used. Feel
 * free to modify it if you need that color in your mapping.
 * NOTE: C_WORD actually use a valid color which cannot then be used. Feel
 * free to modify it if you need that color in your mapping.
 */
#define C_TRANS_R 1
#define C_TRANS_G 1
#define C_TRANS_B 1
#define C_TRANS {C_TRANS_R, C_TRANS_G, C_TRANS_B}
#define C_WORD_R 2
#define C_WORD_G 2
#define C_WORD_B 2
#define C_WORD {C_WORD_R, C_WORD_G, C_WORD_B}

#define COL_LAYOUT_moonlander( \
    k00, k01, k02, k03, k04, k05, k06,   k60, k61, k62, k63, k64, k65, k66, \
    k10, k11, k12, k13, k14, k15, k16,   k70, k71, k72, k73, k74, k75, k76, \
    k20, k21, k22, k23, k24, k25, k26,   k80, k81, k82, k83, k84, k85, k86, \
    k30, k31, k32, k33, k34, k35,             k91, k92, k93, k94, k95, k96, \
    k40, k41, k42, k43, k44,      k53,   kb3,      ka2, ka3, ka4, ka5, ka6, \
                        k50, k51, k52,   kb4, kb5, kb6 \
) \
{ \
    k00, k10, k20, k30, k40, \
    k01, k11, k21, k31, k41, \
    k02, k12, k22, k32, k42, \
    k03, k13, k23, k33, k43, \
    k04, k14, k24, k34, k44, \
    k05, k15, k25, k35, \
    k06, k16, k26, \
    k50, k51, k52, k53, \
    \
    k66, k76, k86, k96, ka6, \
    k65, k75, k85, k95, ka5, \
    k64, k74, k84, k94, ka4, \
    k63, k73, k83, k93, ka3, \
    k62, k72, k82, k92, ka2, \
    k61, k71, k81, k91, \
    k60, k70, k80, \
    kb6, kb5, kb4, kb3, \
    \
}

#define MAP_ALL_KEYS(col)  { col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col, col }

#define C_BLACK  {0, 0, 0}

#define C_LIGHT_RED  {239, 162, 161}
#define C_RED  {255, 51, 50}
#define C_INTENSE_RED  {255, 0, 0}

#define C_LIGHT_BLUE  {88, 147, 218}
#define C_BLUE  {30, 157, 255}
#define C_INTENSE_BLUE  {12, 0, 255}

#define C_LIGHT_GREEN  {204, 255, 153}
#define C_GREEN  {102, 204, 0}
#define C_INTENSE_GREEN  {0, 64, 1}

#define C_LIGHT_YELLOW  {255, 255, 153}
#define C_YELLOW  {214, 161, 0}
#define C_INTENSE_YELLOW  {255, 162, 0}

#define C_LIGHT_PURPLE  {134, 138, 255}
#define C_PURPLE  {127, 0, 255}
#define C_INTENSE_PURPLE  {64, 0, 60}

#define C_LIGHT_ORANGE  {255, 204, 153}
#define C_ORANGE  {227, 84, 26}
#define C_INTENSE_ORANGE  {255, 128, 0}
#define C_BROWN  {149, 86, 51}

#define C_WORD_MODE_ON  C_INTENSE_BLUE
#define C_WORD_MODE_OFF C_LIGHT_BLUE

// make the transparent color macro for colors
// Color key mapping
const uint8_t PROGMEM ledmap[__LAYER_END__][RGB_MATRIX_LED_COUNT][3] = {
  [BEPO__] = MAP_ALL_KEYS(C_LIGHT_RED),
#define ____________ C_LIGHT_BLUE
  [B4AZER] = COL_LAYOUT_moonlander(
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,                                                 ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ ,                ____________          ,          ____________                , ____________ , ____________ , ____________ , ____________ , ____________ ,
                                                                C_WORD       , ____________ , ____________          ,          ____________ , ____________ , ____________
  ),
#undef ____________
  [B4AZ_A] = MAP_ALL_KEYS(C_TRANS),
  [B4AZ_S] = MAP_ALL_KEYS(C_TRANS),
#define ____________ C_BLACK
  [SHRB4Z] = COL_LAYOUT_moonlander(
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    C_BROWN      , ____________ , C_GREEN      , C_GREEN      , C_GREEN      , ____________ ,                                                 ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , C_INTENSE_BLUE , ____________ ,                ____________          ,          ____________                , ____________ , ____________ , ____________ , ____________ , ____________ ,
                                                                ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________
  ),
#undef ____________
#define ____________ C_BLACK
  [LAYERS] = COL_LAYOUT_moonlander(
    ____________ , C_LIGHT_RED  , C_GREEN      , C_BLUE       , C_LIGHT_BLUE , C_ORANGE     , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    C_INTENSE_RED, ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    C_BROWN      , ____________ , ____________ , ____________ , ____________ , ____________ ,                                                 ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ ,                ____________          ,          ____________                , ____________ , ____________ , ____________ , ____________ , ____________ ,
                                                                ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________
  ),
#undef ____________
#define ____________ C_TRANS
  [SYMBOL] = COL_LAYOUT_moonlander(
    ____________ , C_RED        , C_RED        , C_RED        , C_RED        , C_RED        , C_GREEN               ,           C_GREEN     , C_RED        , C_RED        , C_RED        , C_RED        , C_RED        , C_RED        ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , C_GREEN               ,           C_GREEN     , ____________ , C_YELLOW     , C_YELLOW     , C_YELLOW     , C_LIGHT_PURPLE , C_RED        ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , C_GREEN               ,           C_GREEN     , ____________ , C_YELLOW     , C_YELLOW     , C_YELLOW     , C_LIGHT_PURPLE , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,                                                 ____________ , C_YELLOW     , C_YELLOW     , C_YELLOW     , C_LIGHT_PURPLE , ____________ ,
    ____________ ,C_LIGHT_YELLOW, ____________ , ____________ , ____________ ,                ____________          ,          ____________                , C_YELLOW     , C_LIGHT_PURPLE , C_LIGHT_PURPLE , C_LIGHT_PURPLE , ____________ ,
                                                                ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________
  ),
#undef ____________
#define ____________ C_TRANS
  [MEDIA_] = COL_LAYOUT_moonlander(
    C_BLUE       , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , C_LIGHT_PURPLE,
    C_BLUE       , ____________ , ____________ , C_YELLOW     , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    C_BLUE       , ____________ , C_YELLOW     , C_YELLOW     , C_YELLOW     , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , C_RED        ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,                                                 ____________ , ____________ , C_RED        , C_RED        , ____________ , ____________ ,
    ____________ ,C_LIGHT_YELLOW, ____________ , ____________ , ____________ ,                ____________          ,          ____________                , C_ORANGE     , C_ORANGE     , C_ORANGE     , ____________ , ____________ ,
                                                                C_YELLOW     , C_YELLOW     , C_YELLOW              ,          ____________ , ____________ , ____________
  ),
#undef ____________
#define ____________ C_TRANS
  [COLORS] = COL_LAYOUT_moonlander(
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , C_LIGHT_PURPLE , C_LIGHT_PURPLE , C_LIGHT_PURPLE , C_LIGHT_PURPLE , ____________ , ____________ ,
    ____________ ,C_INTENSE_BLUE,C_INTENSE_GREEN,C_INTENSE_YELLOW,C_INTENSE_PURPLE,C_INTENSE_RED, ____________          ,          ____________ , C_LIGHT_PURPLE , C_LIGHT_PURPLE , C_LIGHT_PURPLE , C_LIGHT_PURPLE , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,                                                 ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ ,C_LIGHT_YELLOW, ____________ , ____________ , ____________ ,                C_ORANGE              ,           C_ORANGE                   , ____________ , ____________ , ____________ , ____________ , ____________ ,
                                                                C_ORANGE     , C_ORANGE     , ____________          ,          ____________ , ____________ , ____________
  ),
#undef ____________
  [TERM__] = MAP_ALL_KEYS(C_TRANS),
  [VIM___] = MAP_ALL_KEYS(C_TRANS),
/*
 * Add the following line for new layers
 *
#define ____________ C_TRANS
  [L_NAME] = COL_LAYOUT_moonlander(
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,                                                 ____________ , ____________ , ____________ , ____________ , ____________ , ____________ ,
    ____________ , ____________ , ____________ , ____________ , ____________ ,                ____________          ,          ____________                , ____________ , ____________ , ____________ , ____________ , ____________ ,
                                                                ____________ , ____________ , ____________          ,          ____________ , ____________ , ____________
  ),
#undef ____________
 */
};
// undefine transparency

// the active layers needs to be composed from the current state and the
// defaul layout
#define ACTIVE_LAYER_STATE layer_state | default_layer_state

RGB get_key_color(int layer, int key) {
    // handle inactive layers
    // IS_LAYER_OFF_STATE only works for non-null layers
    // The layer 0 is always active
    if (layer > 0 && IS_LAYER_OFF_STATE(ACTIVE_LAYER_STATE, layer)) {
        return get_key_color(layer - 1, key);
    }
    // read the active layer colors
    RGB rgb = {
      .r = pgm_read_byte(&ledmap[layer][key][0]),
      .g = pgm_read_byte(&ledmap[layer][key][1]),
      .b = pgm_read_byte(&ledmap[layer][key][2]),
    };
    if (rgb.r == C_TRANS_R && rgb.g == C_TRANS_G && rgb.b == C_TRANS_B) {
        if (layer > 0) {
            return get_key_color(layer - 1, key);
        } else {
            // default to no color
            return (RGB) C_BLACK;
        }
    } else if (rgb.r == C_WORD_R && rgb.g == C_WORD_G && rgb.b == C_WORD_B) {
		if (g_word_mode) {
			return (RGB) C_WORD_MODE_ON;
		} else {
			return (RGB) C_WORD_MODE_OFF;
		}
	}
    return rgb;
}

void set_layer_color(int layer) {
  for (int i = 0; i < RGB_MATRIX_LED_COUNT; i++) {
      // find the color for the current key and layer
      RGB rgb = get_key_color(layer, i);
      rgb_matrix_set_color(i, rgb.r, rgb.g, rgb.b);
  }
}

bool rgb_matrix_indicators_user(void) {
    if (rgb_matrix_get_suspend_state() || keyboard_config.disable_layer_led) { return false; }

    uint8_t layer = biton32(ACTIVE_LAYER_STATE);
    // for layers (it should always be the case, use the color defined in
    // the mapping
    if (layer < __LAYER_END__) {
        set_layer_color(layer);
    } else {
        // else set it to black if led are not enabled
        if (rgb_matrix_get_flags() == LED_FLAG_NONE)
            rgb_matrix_set_color_all(0, 0, 0);
    }
	return true;
}



/****************************************
 * TAP DANCE
 ***************************************/

// adaptation of the code from QMK doc
typedef enum {
    TD_NONE,
    TD_UNKNOWN,
    TD_SINGLE_TAP,
    TD_SINGLE_HOLD,
    TD_DOUBLE_TAP,
    TD_DOUBLE_HOLD,
    TD_DOUBLE_SINGLE_TAP, // Send two single taps
    TD_TRIPLE_TAP,
    TD_TRIPLE_HOLD
} td_state_t;

typedef struct {
    td_state_t state;
} td_tap_t;

/* Return an integer that corresponds to what kind of tap dance should be executed.
 *
 * How to figure out tap dance state: interrupted and pressed.
 *
 * Interrupted: If the state of a dance dance is "interrupted", that means that another key has been hit
 *  under the tapping term. This is typically indicitive that you are trying to "tap" the key.
 *
 * Pressed: Whether or not the key is still being pressed. If this value is true, that means the tapping term
 *  has ended, but the key is still being pressed down. This generally means the key is being "held".
 *
 * One thing that is currenlty not possible with qmk software in regards to tap dance is to mimic the "permissive hold"
 *  feature. In general, advanced tap dances do not work well if they are used with commonly typed letters.
 *  For example "A". Tap dances are best used on non-letter keys that are not hit while typing letters.
 *
 * Good places to put an advanced tap dance:
 *  z,q,x,j,k,v,b, any function key, home/end, comma, semi-colon
 *
 * Criteria for "good placement" of a tap dance key:
 *  Not a key that is hit frequently in a sentence
 *  Not a key that is used frequently to double tap, for example 'tab' is often double tapped in a terminal, or
 *    in a web form. So 'tab' would be a poor choice for a tap dance.
 *  Letters used in common words as a double. For example 'p' in 'pepper'. If a tap dance function existed on the
 *    letter 'p', the word 'pepper' would be quite frustating to type.
 *
 * For the third point, there does exist the 'TD_DOUBLE_SINGLE_TAP', however this is not fully tested
 *
 */
td_state_t cur_dance(tap_dance_state_t *state) {
    if (state->count == 1) {
        if (state->interrupted || !state->pressed) return TD_SINGLE_TAP;
        // Key has not been interrupted, but the key is still held. Means you want to send a 'HOLD'.
        else return TD_SINGLE_HOLD;
    } else if (state->count == 2) {
        // TD_DOUBLE_SINGLE_TAP is to distinguish between typing "pepper", and actually wanting a double tap
        // action when hitting 'pp'. Suggested use case for this return value is when you want to send two
        // keystrokes of the key, and not the 'double tap' action/macro.
        if (state->interrupted) return TD_DOUBLE_SINGLE_TAP;
        else if (state->pressed) return TD_DOUBLE_HOLD;
        else return TD_DOUBLE_TAP;
    }

    // Assumes no one is trying to type the same letter three times (at least not quickly).
    // If your tap dance key is 'KC_W', and you want to type "www." quickly - then you will need to add
    // an exception here to return a 'TD_TRIPLE_SINGLE_TAP', and define that enum just like 'TD_DOUBLE_SINGLE_TAP'
    if (state->count == 3) {
        if (state->interrupted || !state->pressed) return TD_TRIPLE_TAP;
        else return TD_TRIPLE_HOLD;
    } else return TD_UNKNOWN;
}

static td_tap_t dance_state[__TD_END__];


/*
 * The following macros can be used to have Tap Dance to:
 * - hold mod1 on first press and hold (permissive hold)
 * - hold mod2 on second press and hold (permissive hold)
 * - hold mod3 on third press and hold (permissive hold)
 *
 * Usage:
 *   TD_MOD(TD_KEY_NAME, MOD(mod1), MOD(mod2), MOD(mod3))
 *   TD_MOD2(TD_KEY_NAME, mod1, mod2) --> same as TD_MOD but for 2 mods only
 *   MOD(mod) --> create the modifier for TD_MODE
 *   MOD2(mod1, mod2)  --> same as MOD, but sending 2 modifiers
 *   MOD3(mod1, mod2, mod3)  --> same as MOD, but sending 3 modifiers
 *   TD_MOD_REF(TD_KEY_NAME)
 *
 */
#define _TD_MOD(name, reg_mod1, unreg_mod1, reg_mod2, unreg_mod2, reg_mod3, unreg_mod3)  \
void x_tap_##name(tap_dance_state_t *state, void *user_data) { \
    switch (state->count) { \
        case 1: \
            reg_mod1; \
            dance_state[name].state = TD_SINGLE_HOLD; \
            break; \
        case 2: \
            unreg_mod1; \
            reg_mod2; \
            dance_state[name].state = TD_DOUBLE_HOLD; \
            break; \
        case 3: \
        default: \
            unreg_mod2; \
            reg_mod3; \
            dance_state[name].state = TD_TRIPLE_HOLD; \
            break; \
    } \
} \
void x_reset_##name(tap_dance_state_t *state, void *user_data) { \
    switch (dance_state[name].state) { \
        case TD_SINGLE_HOLD: unreg_mod1; break; \
        case TD_DOUBLE_HOLD: unreg_mod2; break; \
        case TD_TRIPLE_HOLD: unreg_mod3; break; \
        default: break; \
    } \
    dance_state[name].state = TD_NONE; \
}
#define TD_MOD(...)  _TD_MOD(__VA_ARGS__)
#define _TD_MOD2(name, r1, u1, r2, u2)  TD_MOD(name, r1, u1, r2, u2, r2, u2)
#define TD_MOD2(...)  _TD_MOD2(__VA_ARGS__)
#define MOD(mod) { register_code(KC_##mod); }, { unregister_code(KC_##mod); }
#define MOD2(mod1, mod2) { register_code(KC_##mod1); register_code(KC_##mod2); }, { unregister_code(KC_##mod1); unregister_code(KC_##mod2); }
#define MOD3(mod1, mod2, mod3) { register_code(KC_##mod1); register_code(KC_##mod2); register_code(KC_##mod3); }, { unregister_code(KC_##mod1); unregister_code(KC_##mod2); unregister_code(KC_##mod3); }
#define LAYER(layer) { layer_on(layer); }, { layer_off(layer); }
#define TD_MOD_REF(name) ACTION_TAP_DANCE_FN_ADVANCED(x_tap_##name, NULL, x_reset_##name)

TD_MOD2(TD_SHF_ALT, MOD(RSFT), MOD2(RSFT, RALT))

tap_dance_action_t tap_dance_actions[] = {
        [TD_SHF_ALT] = TD_MOD_REF(TD_SHF_ALT),
};
